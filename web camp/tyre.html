<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Tyre Management System</title>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Segoe UI', sans-serif;
      background-color: #f5f5f5;
      color: #333;
    }

    .container {
      max-width: 1200px;
      margin: 30px auto;
      padding: 20px;
      background-color: #fff;
      border-radius: 10px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    }

    .container h1, h2, h3 {
      color: #2E8B57;
      margin-bottom: 20px;
    }

    .alert {
      padding: 15px;
      margin-bottom: 20px;
      border-radius: 5px;
      font-weight: 500;
    }

    .alert-success {
      background-color: #d4edda;
      color: #155724;
      border-left: 4px solid #28a745;
    }

    .alert-danger {
      background-color: #f8d7da;
      color: #721c24;
      border-left: 4px solid #dc3545;
    }

    .alert-warning {
      background-color: #fff3cd;
      color: #856404;
      border-left: 4px solid #ffc107;
    }

    .form-section {
      background-color: #f9f9f9;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 30px;
      border: 1px solid #eee;
    }

    .form-group {
      margin-bottom: 15px;
    }

    .form-group label {
      display: block;
      margin-bottom: 5px;
      font-weight: 500;
    }

    .form-group input, .form-group select {
      width: 100%;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 5px;
      font-size: 16px;
    }

    .form-group input:focus, .form-group select:focus {
      outline: none;
      border-color: #2E8B57;
      box-shadow: 0 0 5px rgba(46, 139, 87, 0.2);
    }

    .btn {
      padding: 10px 15px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 16px;
      font-weight: 500;
      transition: all 0.3s ease;
    }

    .btn-primary {
      background-color: #2E8B57;
      color: white;
    }

    .btn-primary:hover {
      background-color: #267349;
    }

    .btn-danger {
      background-color: #dc3545;
      color: white;
    }

    .btn-danger:hover {
      background-color: #c82333;
    }

    .btn-warning {
      background-color: #ffc107;
      color: #212529;
    }

    .btn-warning:hover {
      background-color: #e0a800;
    }

    .tyre-container {
      background-color: #f9f9f9;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 15px;
      border-left: 4px solid #2E8B57;
    }

    .tyre-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }

    .tyre-title {
      font-weight: 600;
      color: #333;
      font-size: 18px;
    }

    .remove-tyre {
      background-color: #dc3545;
      color: white;
      border: none;
      padding: 5px 10px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 14px;
    }

    .remove-tyre:hover {
      background-color: #c82333;
    }

    .tyre-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
    }

    .vehicle-card {
      background-color: #f9f9f9;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 20px;
      border-left: 4px solid #2E8B57;
    }

    .vehicle-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
      font-weight: 600;
      color: #333;
      font-size: 18px;
    }

    .vehicle-actions {
      display: flex;
      gap: 10px;
    }

    .tyre-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
      gap: 15px;
    }

    .tyre-card {
      background-color: white;
      padding: 15px;
      border-radius: 8px;
      border: 1px solid #ddd;
      position: relative;
    }

    .tyre-actions {
      position: absolute;
      top: 10px;
      right: 10px;
      display: flex;
      gap: 5px;
    }

    .action-btn {
      padding: 5px 10px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 12px;
      color: white;
    }

    .edit-btn {
      background-color: #ffc107;
      color: #212529;
    }

    .delete-btn {
      background-color: #dc3545;
    }

    .duplicate-btn {
      background-color: #17a2b8;
    }

    .search-section {
      margin-bottom: 20px;
    }

    .search-input {
      width: 100%;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 5px;
      font-size: 16px;
      margin-bottom: 10px;
    }

    @media (max-width: 768px) {
      .container {
        padding: 15px;
      }
      
      .tyre-row {
        grid-template-columns: 1fr;
      }
      
      .tyre-grid {
        grid-template-columns: 1fr;
      }
      
      .vehicle-header {
        flex-direction: column;
        align-items: flex-start;
      }
      
      .vehicle-actions {
        margin-top: 10px;
      }
    }
  </style>
</head>
<body>
  <div id="navbar"></div>

  <div class="container">
    <h1>Tyre Management System</h1>
    
    <div id="alertContainer"></div>
    
    <!-- Search Section -->
    <div class="search-section">
      <h3>Search Vehicles</h3>
      <input type="text" id="searchInput" class="search-input" placeholder="Search by vehicle number, model, or tyre details...">
      <button class="btn btn-primary" onclick="searchVehicles()">Search</button>
      <button class="btn btn-primary" onclick="loadVehicles()">Show All</button>
    </div>
    
    <!-- Add Vehicle Form -->
    <div class="form-section">
      <h3 id="formTitle">Add New Vehicle</h3>
      
      <div class="form-group">
        <label for="vehicleNumber">Vehicle Number:</label>
        <input type="text" id="vehicleNumber" placeholder="e.g., RJ38GA2433" required>
      </div>
      
      <div class="form-group">
        <label for="vehicleModel">Vehicle Model:</label>
        <input type="text" id="vehicleModel" placeholder="e.g., Tata Bulker Z" required>
      </div>
      
      <div id="tyresContainer">
        <div class="tyre-container">
          <div class="tyre-header">
            <span class="tyre-title">Tyre 1</span>
          </div>
          <div class="tyre-row">
            <div class="form-group">
              <label>Tyre Number:</label>
              <input type="text" class="tyre-number" placeholder="e.g., T001" required>
            </div>
            <div class="form-group">
              <label>Brand:</label>
              <input type="text" class="tyre-brand" placeholder="e.g., Apollo" required>
            </div>
            <div class="form-group">
              <label>Size:</label>
              <input type="text" class="tyre-size" placeholder="e.g., 195/65R15" required>
            </div>
            <div class="form-group">
              <label>Position:</label>
              <input type="text" class="tyre-position" placeholder="e.g., Front Left" required>
            </div>
          </div>
        </div>
      </div>
      
      <button class="btn btn-primary" onclick="addTyre()">Add Another Tyre</button>
      <button class="btn btn-primary" id="saveVehicleBtn" onclick="saveVehicle()">Save Vehicle</button>
      <button class="btn btn-danger" id="cancelEditBtn" onclick="cancelEdit()" style="display: none;">Cancel</button>
    </div>
    
    <!-- Vehicle List Section -->
    <div class="form-section">
      <h3>Vehicle List</h3>
      <div id="vehicleList"></div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getAuth, onAuthStateChanged ,signOut } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
    import { getDatabase, ref, set, push, onValue, update, remove, get, child } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDAlk_K8p8Of8Ne6Jpcl2QqXTtm95NgG7o",
      authDomain: "transport-dashboard-ad69a.firebaseapp.com",
      databaseURL: "https://transport-dashboard-ad69a-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "transport-dashboard-ad69a",
      storageBucket: "transport-dashboard-ad69a.appspot.com",
      messagingSenderId: "526889676196",
      appId: "1:526889676196:web:66032c80a4aede690ae531",
      measurementId: "G-7F9R7HJYDH"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);
    let currentUser = null;
    let editingVehicleId = null;
    let tyreCount = 1;
    
    // Make Firebase functions available globally
    window.db = db;
    window.ref = ref;
    window.get = get;
    window.currentUser = null; // Will be updated in onAuthStateChanged

    // Load navbar
    fetch('navbar.html')
      .then(response => response.text())
      .then(html => {
        document.getElementById('navbar').innerHTML = html;
      });

    // Check authentication
    onAuthStateChanged(auth, (user) => {
      if (!user) {
        window.location.href = "index.html";
        return;
      }
      currentUser = user;
      window.currentUser = user; // Update the global reference
      loadVehicles();
    });

    // Show alert message
    window.showAlert = function(message, type) {
      const alertContainer = document.getElementById('alertContainer');
      const alert = document.createElement('div');
      alert.className = `alert alert-${type}`;
      alert.textContent = message;
      alertContainer.appendChild(alert);
      
      setTimeout(() => {
        alert.remove();
      }, 3000);
    };

    // Add new tyre input fields
    window.addTyre = function() {
      tyreCount++;
      const tyresContainer = document.getElementById('tyresContainer');
      
      const tyreDiv = document.createElement('div');
      tyreDiv.className = 'tyre-container';
      tyreDiv.innerHTML = `
        <div class="tyre-header">
          <span class="tyre-title">Tyre ${tyreCount}</span>
          <button class="remove-tyre" onclick="removeTyre(this)">Remove</button>
        </div>
        <div class="tyre-row">
          <div class="form-group">
            <label>Tyre Number:</label>
            <input type="text" class="tyre-number" placeholder="e.g., T00${tyreCount}" required>
          </div>
          <div class="form-group">
            <label>Brand:</label>
            <input type="text" class="tyre-brand" placeholder="e.g., MRF" required>
          </div>
          <div class="form-group">
            <label>Size:</label>
            <input type="text" class="tyre-size" placeholder="e.g., 195/65R15" required>
          </div>
          <div class="form-group">
            <label>Position:</label>
            <input type="text" class="tyre-position" placeholder="e.g., Front Right" required>
          </div>
        </div>
      `;
      
      tyresContainer.appendChild(tyreDiv);
    };

    // Remove tyre input fields
    window.removeTyre = function(button) {
      const tyreContainer = button.closest('.tyre-container');
      tyreContainer.remove();
      
      // Update tyre titles
      const tyreTitles = document.querySelectorAll('.tyre-title');
      tyreTitles.forEach((title, index) => {
        title.textContent = `Tyre ${index + 1}`;
      });
      
      tyreCount = tyreTitles.length;
    };

    // Save vehicle and tyres
    window.saveVehicle = async function() {
      const vehicleNumber = document.getElementById('vehicleNumber').value.trim().toUpperCase();
      const vehicleModel = document.getElementById('vehicleModel').value.trim();
      
      if (!vehicleNumber || !vehicleModel) {
        showAlert('Please fill in all vehicle details', 'warning');
        return;
      }
      
      // Get all tyre inputs
      const tyreContainers = document.querySelectorAll('.tyre-container');
      const tyres = [];
      const tyreNumbers = new Set();
      
      for (const container of tyreContainers) {
        const tyreNumber = container.querySelector('.tyre-number').value.trim();
        const tyreBrand = container.querySelector('.tyre-brand').value.trim();
        const tyreSize = container.querySelector('.tyre-size').value.trim();
        const tyrePosition = container.querySelector('.tyre-position').value.trim();
        
        if (!tyreNumber || !tyreBrand || !tyreSize || !tyrePosition) {
          showAlert('Please fill in all tyre details', 'warning');
          return;
        }
        
        // Check for duplicate tyre numbers within the form
        if (tyreNumbers.has(tyreNumber)) {
          showAlert(`Duplicate tyre number: ${tyreNumber}`, 'danger');
          return;
        }
        
        tyreNumbers.add(tyreNumber);
        
        tyres.push({
          number: tyreNumber,
          brand: tyreBrand,
          size: tyreSize,
          position: tyrePosition,
          addedAt: Date.now()
        });
      }
      
      if (tyres.length === 0) {
        showAlert('Please add at least one tyre', 'warning');
        return;
      }
      
      // Check if vehicle number already exists (for new vehicles)
      if (!editingVehicleId) {
        const vehiclesRef = ref(db, `users/${currentUser.uid}/vehicles`);
        const snapshot = await get(vehiclesRef);
        
        if (snapshot.exists()) {
          const vehicles = snapshot.val();
          for (const key in vehicles) {
            if (vehicles[key].vehicleNumber === vehicleNumber) {
              showAlert(`Vehicle with number ${vehicleNumber} already exists`, 'danger');
              return;
            }
          }
        }
      }
      
      // Check for duplicate tyre numbers in database (for all tyres)
      const allTyresRef = ref(db, `users/${currentUser.uid}/vehicles`);
      const allTyresSnapshot = await get(allTyresRef);
      
      if (allTyresSnapshot.exists()) {
        const vehicles = allTyresSnapshot.val();
        
        for (const vehicleKey in vehicles) {
          // Skip checking the vehicle we're currently editing
          if (editingVehicleId && vehicleKey === editingVehicleId) continue;
          
          const vehicleTyres = vehicles[vehicleKey].tyres || [];
          
          for (const tyre of tyres) {
            for (const existingTyre of vehicleTyres) {
              if (existingTyre.number === tyre.number) {
                showAlert(`Tyre number ${tyre.number} already exists in vehicle ${vehicles[vehicleKey].vehicleNumber}`, 'danger');
                return;
              }
            }
          }
        }
      }
      
      const vehicleData = {
        vehicleNumber,
        vehicleModel,
        tyres,
        updatedAt: Date.now()
      };
      
      try {
        if (editingVehicleId) {
          // Update existing vehicle
          await update(ref(db, `users/${currentUser.uid}/vehicles/${editingVehicleId}`), vehicleData);
          showAlert('Vehicle updated successfully', 'success');
        } else {
          // Add new vehicle
          await push(ref(db, `users/${currentUser.uid}/vehicles`), vehicleData);
          showAlert('Vehicle added successfully', 'success');
        }
        
        // Reset form
        resetForm();
        loadVehicles();
      } catch (error) {
        showAlert(`Error: ${error.message}`, 'danger');
      }
    };

    // Load vehicles from database
    window.loadVehicles = function() {
      const vehicleListContainer = document.getElementById('vehicleList');
      vehicleListContainer.innerHTML = '<p>Loading vehicles...</p>';
      
      const vehiclesRef = ref(db, `users/${currentUser.uid}/vehicles`);
      
      onValue(vehiclesRef, (snapshot) => {
        if (!snapshot.exists()) {
          vehicleListContainer.innerHTML = '<p>No vehicles found</p>';
          return;
        }
        
        const vehicles = snapshot.val();
        let vehicleHtml = '';
        
        for (const vehicleId in vehicles) {
          const vehicle = vehicles[vehicleId];
          const tyres = vehicle.tyres || [];
          
          let tyresHtml = '';
          for (const tyre of tyres) {
            // Add age badge to each tyre
            const tyreAge = getTyreAge(tyre.addedAt);
            let badgeClass = 'badge-new';
            let badgeText = 'New';
            
            if (tyreAge > 180) { // older than 6 months
              badgeClass = 'badge-old';
              badgeText = 'Old';
            } else if (tyreAge > 30) { // older than 1 month
              badgeClass = 'badge-used';
              badgeText = 'Used';
            }
            
            tyresHtml += `
              <div class="tyre-card">
                <div class="tyre-actions">
                  <button class="action-btn edit-btn" onclick="editTyre('${vehicleId}', '${tyre.number}')">Edit</button>
                  <button class="action-btn delete-btn" onclick="disposeTyre('${vehicleId}', '${tyre.number}')">Dispose</button>
                </div>
                <p><strong>Number:</strong> ${tyre.number} <span class="tyre-badge ${badgeClass}">${badgeText}</span></p>
                <p><strong>Brand:</strong> ${tyre.brand}</p>
                <p><strong>Size:</strong> ${tyre.size}</p>
                <p><strong>Position:</strong> ${tyre.position}</p>
              </div>
            `;
          }
          
          vehicleHtml += `
            <div class="vehicle-card">
              <div class="vehicle-header">
                <div>${vehicle.vehicleNumber} - ${vehicle.vehicleModel}</div>
                <div class="vehicle-actions">
                  <button class="btn btn-primary" onclick="addTyreToVehicle('${vehicleId}')">Add Tyre</button>
                  <button class="btn history-btn" onclick="showTyreHistory('${vehicleId}')">Tyre History</button>
                  <button class="btn btn-warning" onclick="editVehicle('${vehicleId}')">Edit Vehicle</button>
                  <button class="btn btn-danger" onclick="deleteVehicle('${vehicleId}')">Delete Vehicle</button>
                </div>
              </div>
              <div class="tyre-grid">
                ${tyresHtml}
              </div>
            </div>
          `;
        }
        
        vehicleListContainer.innerHTML = vehicleHtml;
      });
    };

    // Search vehicles
    window.searchVehicles = function() {
      const searchTerm = document.getElementById('searchInput').value.trim().toLowerCase();
      
      if (!searchTerm) {
        loadVehicles();
        return;
      }
      
      const vehicleListContainer = document.getElementById('vehicleList');
      vehicleListContainer.innerHTML = '<p>Searching...</p>';
      
      const vehiclesRef = ref(db, `users/${currentUser.uid}/vehicles`);
      
      onValue(vehiclesRef, (snapshot) => {
        if (!snapshot.exists()) {
          vehicleListContainer.innerHTML = '<p>No vehicles found</p>';
          return;
        }
        
        const vehicles = snapshot.val();
        let vehicleHtml = '';
        let resultsFound = false;
        
        for (const vehicleId in vehicles) {
          const vehicle = vehicles[vehicleId];
          const tyres = vehicle.tyres || [];
          
          // Check if vehicle details match search term
          const vehicleMatches = 
            vehicle.vehicleNumber.toLowerCase().includes(searchTerm) || 
            vehicle.vehicleModel.toLowerCase().includes(searchTerm);
          
          // Check if any tyre details match search term
          const tyreMatches = tyres.some(tyre => 
            tyre.number.toLowerCase().includes(searchTerm) || 
            tyre.brand.toLowerCase().includes(searchTerm) || 
            tyre.size.toLowerCase().includes(searchTerm) || 
            tyre.position.toLowerCase().includes(searchTerm)
          );
          
          if (vehicleMatches || tyreMatches) {
            resultsFound = true;
            
            let tyresHtml = '';
            for (const tyre of tyres) {
              tyresHtml += `
                <div class="tyre-card">
                  <div class="tyre-actions">
                    <button class="action-btn edit-btn" onclick="editTyre('${vehicleId}', '${tyre.number}')">Edit</button>
                    <button class="action-btn delete-btn" onclick="deleteTyre('${vehicleId}', '${tyre.number}')">Delete</button>
                  </div>
                  <p><strong>Number:</strong> ${tyre.number}</p>
                  <p><strong>Brand:</strong> ${tyre.brand}</p>
                  <p><strong>Size:</strong> ${tyre.size}</p>
                  <p><strong>Position:</strong> ${tyre.position}</p>
                </div>
              `;
            }
            
            vehicleHtml += `
              <div class="vehicle-card">
                <div class="vehicle-header">
                  <div>${vehicle.vehicleNumber} - ${vehicle.vehicleModel}</div>
                  <div class="vehicle-actions">
                    <button class="btn btn-primary" onclick="addTyreToVehicle('${vehicleId}')">Add Tyre</button>
                    <button class="btn btn-warning" onclick="editVehicle('${vehicleId}')">Edit Vehicle</button>
                    <button class="btn btn-danger" onclick="deleteVehicle('${vehicleId}')">Delete Vehicle</button>
                  </div>
                </div>
                <div class="tyre-grid">
                  ${tyresHtml}
                </div>
              </div>
            `;
          }
        }
        
        if (resultsFound) {
          vehicleListContainer.innerHTML = vehicleHtml;
        } else {
          vehicleListContainer.innerHTML = '<p>No matching vehicles found</p>';
        }
      });
    };

    // Edit vehicle
    window.editVehicle = function(vehicleId) {
      const vehicleRef = ref(db, `users/${currentUser.uid}/vehicles/${vehicleId}`);
      
      get(vehicleRef).then((snapshot) => {
        if (snapshot.exists()) {
          const vehicle = snapshot.val();
          
          // Set form to edit mode
          document.getElementById('formTitle').textContent = 'Edit Vehicle';
          document.getElementById('vehicleNumber').value = vehicle.vehicleNumber;
          document.getElementById('vehicleModel').value = vehicle.vehicleModel;
          
          // Clear existing tyre inputs
          document.getElementById('tyresContainer').innerHTML = '';
          
          // Add tyre inputs for each existing tyre
          const tyres = vehicle.tyres || [];
          tyreCount = 0;
          
          for (const tyre of tyres) {
            tyreCount++;
            const tyreDiv = document.createElement('div');
            tyreDiv.className = 'tyre-container';
            tyreDiv.innerHTML = `
              <div class="tyre-header">
                <span class="tyre-title">Tyre ${tyreCount}</span>
                ${tyreCount > 1 ? '<button class="remove-tyre" onclick="removeTyre(this)">Remove</button>' : ''}
              </div>
              <div class="tyre-row">
                <div class="form-group">
                  <label>Tyre Number:</label>
                  <input type="text" class="tyre-number" value="${tyre.number}" required>
                </div>
                <div class="form-group">
                  <label>Brand:</label>
                  <input type="text" class="tyre-brand" value="${tyre.brand}" required>
                </div>
                <div class="form-group">
                  <label>Size:</label>
                  <input type="text" class="tyre-size" value="${tyre.size}" required>
                </div>
                <div class="form-group">
                  <label>Position:</label>
                  <input type="text" class="tyre-position" value="${tyre.position}" required>
                </div>
              </div>
            `;
            
            document.getElementById('tyresContainer').appendChild(tyreDiv);
          }
          
          // If no tyres, add one empty tyre input
          if (tyreCount === 0) {
            addTyre();
          }
          
          // Set editing state
          editingVehicleId = vehicleId;
          document.getElementById('saveVehicleBtn').textContent = 'Update Vehicle';
          document.getElementById('cancelEditBtn').style.display = 'inline-block';
          
          // Scroll to form
          document.querySelector('.form-section').scrollIntoView({ behavior: 'smooth' });
        }
      });
    };

    // Delete vehicle
    window.deleteVehicle = function(vehicleId) {
      if (confirm('Are you sure you want to delete this vehicle and all its tyres?')) {
        remove(ref(db, `users/${currentUser.uid}/vehicles/${vehicleId}`)).then(() => {
          showAlert('Vehicle deleted successfully', 'success');
          loadVehicles();
        }).catch((error) => {
          showAlert(`Error: ${error.message}`, 'danger');
        });
      }
    };

    // Add tyre to existing vehicle
    window.addTyreToVehicle = function(vehicleId) {
      // Set form to add tyre mode
      resetForm();
      document.getElementById('formTitle').textContent = 'Add Tyre to Vehicle';
      
      // Get vehicle details
      get(ref(db, `users/${currentUser.uid}/vehicles/${vehicleId}`)).then((snapshot) => {
        if (snapshot.exists()) {
          const vehicle = snapshot.val();
          
          // Set vehicle fields and disable them
          document.getElementById('vehicleNumber').value = vehicle.vehicleNumber;
          document.getElementById('vehicleModel').value = vehicle.vehicleModel;
          document.getElementById('vehicleNumber').disabled = true;
          document.getElementById('vehicleModel').disabled = true;
          
          // Set editing state
          editingVehicleId = vehicleId;
          document.getElementById('saveVehicleBtn').textContent = 'Add Tyre to Vehicle';
          document.getElementById('cancelEditBtn').style.display = 'inline-block';
          
          // Scroll to form
          document.querySelector('.form-section').scrollIntoView({ behavior: 'smooth' });
        }
      });
    };

    // Edit specific tyre
    window.editTyre = function(vehicleId, tyreNumber) {
      get(ref(db, `users/${currentUser.uid}/vehicles/${vehicleId}`)).then((snapshot) => {
        if (snapshot.exists()) {
          const vehicle = snapshot.val();
          const tyres = vehicle.tyres || [];
          const tyreToEdit = tyres.find(t => t.number === tyreNumber);
          
          if (tyreToEdit) {
            // Set form to edit tyre mode
            resetForm();
            document.getElementById('formTitle').textContent = 'Edit Tyre';
            
            // Set vehicle fields and disable them
            document.getElementById('vehicleNumber').value = vehicle.vehicleNumber;
            document.getElementById('vehicleModel').value = vehicle.vehicleModel;
            document.getElementById('vehicleNumber').disabled = true;
            document.getElementById('vehicleModel').disabled = true;
            
            // Add tyre input with the tyre details
            const tyreDiv = document.createElement('div');
            tyreDiv.className = 'tyre-container';
            tyreDiv.innerHTML = `
              <div class="tyre-header">
                <span class="tyre-title">Edit Tyre</span>
              </div>
              <div class="tyre-row">
                <div class="form-group">
                  <label>Tyre Number:</label>
                  <input type="text" class="tyre-number" value="${tyreToEdit.number}" required>
                </div>
                <div class="form-group">
                  <label>Brand:</label>
                  <input type="text" class="tyre-brand" value="${tyreToEdit.brand}" required>
                </div>
                <div class="form-group">
                  <label>Size:</label>
                  <input type="text" class="tyre-size" value="${tyreToEdit.size}" required>
                </div>
                <div class="form-group">
                  <label>Position:</label>
                  <input type="text" class="tyre-position" value="${tyreToEdit.position}" required>
                </div>
              </div>
            `;
            
            document.getElementById('tyresContainer').innerHTML = '';
            document.getElementById('tyresContainer').appendChild(tyreDiv);
            
            // Set editing state
            editingVehicleId = vehicleId;
            document.getElementById('saveVehicleBtn').textContent = 'Update Tyre';
            document.getElementById('cancelEditBtn').style.display = 'inline-block';
            
            // Scroll to form
            document.querySelector('.form-section').scrollIntoView({ behavior: 'smooth' });
          }
        }
      });
    };

    // Delete specific tyre
    window.disposeTyre = function(vehicleId, tyreNumber) {
      // Create a prompt for disposal reason
      const reason = prompt('Please enter the reason for disposing this tyre:', 'Worn out');
      
      // If user cancels the prompt, don't proceed
      if (reason === null) return;
      
      get(ref(db, `users/${currentUser.uid}/vehicles/${vehicleId}`)).then((snapshot) => {
        if (snapshot.exists()) {
          const vehicle = snapshot.val();
          const tyres = vehicle.tyres || [];
          
          // Find the tyre to dispose
          const tyreToDispose = tyres.find(t => t.number === tyreNumber);
          if (!tyreToDispose) return;
          
          // Add disposal information
          const disposedTyre = {
            ...tyreToDispose,
            disposedAt: Date.now(),
            disposalReason: reason,
            vehicleNumber: vehicle.vehicleNumber,
            vehicleModel: vehicle.vehicleModel
          };
          
          // Save to tyre history
          const historyRef = ref(db, `users/${currentUser.uid}/tyre_history`);
          push(historyRef, disposedTyre).then(() => {
            // Filter out the disposed tyre from vehicle
            const updatedTyres = tyres.filter(t => t.number !== tyreNumber);
            
            // Update the vehicle with the new tyres array
            update(ref(db, `users/${currentUser.uid}/vehicles/${vehicleId}`), {
              tyres: updatedTyres
            }).then(() => {
              showAlert('Tyre disposed successfully', 'success');
            }).catch((error) => {
              showAlert(`Error: ${error.message}`, 'danger');
            });
          }).catch((error) => {
            showAlert(`Error saving to history: ${error.message}`, 'danger');
          });
        }
      });
    };

    // Cancel edit mode
    window.cancelEdit = function() {
      resetForm();
    };

    // Reset form to add new vehicle state
    function resetForm() {
      document.getElementById('formTitle').textContent = 'Add New Vehicle';
      document.getElementById('vehicleNumber').value = '';
      document.getElementById('vehicleModel').value = '';
      document.getElementById('vehicleNumber').disabled = false;
      document.getElementById('vehicleModel').disabled = false;
      
      document.getElementById('tyresContainer').innerHTML = `
        <div class="tyre-container">
          <div class="tyre-header">
            <span class="tyre-title">Tyre 1</span>
          </div>
          <div class="tyre-row">
            <div class="form-group">
              <label>Tyre Number:</label>
              <input type="text" class="tyre-number" placeholder="e.g., T001" required>
            </div>
            <div class="form-group">
              <label>Brand:</label>
              <input type="text" class="tyre-brand" placeholder="e.g., MRF" required>
            </div>
            <div class="form-group">
              <label>Size:</label>
              <input type="text" class="tyre-size" placeholder="e.g., 195/65R15" required>
            </div>
            <div class="form-group">
              <label>Position:</label>
              <input type="text" class="tyre-position" placeholder="e.g., Front Left" required>
            </div>
          </div>
        </div>
      `;
      
      tyreCount = 1;
      editingVehicleId = null;
      document.getElementById('saveVehicleBtn').textContent = 'Save Vehicle';
      document.getElementById('cancelEditBtn').style.display = 'none';
    }
    window.logout = function() {
        signOut(auth).then(() => {
          window.location.href = "index.html";
        }).catch(error => {
          alert("Error logging out: " + error.message);
        });
    };

    window.toggleMenu = function () {
      document.getElementById("navLinks").classList.toggle("show");
    };
  </script>
</body>
</html>

<!-- Add this CSS inside the existing style tag -->
<style>
  /* ... existing styles ... */
  
  /* Styles for tyre history */
  .history-btn {
    background-color: #17a2b8;
    color: white;
  }
  
  .history-btn:hover {
    background-color: #138496;
  }
  
  .modal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    overflow: auto;
    background-color: rgba(0, 0, 0, 0.4);
  }
  
  .modal-content {
    background-color: #fefefe;
    margin: 10% auto;
    padding: 20px;
    border-radius: 10px;
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
    width: 80%;
    max-width: 800px;
  }
  
  .close-modal {
    color: #aaa;
    float: right;
    font-size: 28px;
    font-weight: bold;
    cursor: pointer;
  }
  
  .close-modal:hover {
    color: #555;
  }
  
  .history-table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 15px;
  }
  
  .history-table th, .history-table td {
    border: 1px solid #ddd;
    padding: 10px;
    text-align: left;
  }
  
  .history-table th {
    background-color: #2E8B57;
    color: white;
  }
  
  .history-table tr:nth-child(even) {
    background-color: #f2f2f2;
  }
  
  .tyre-stats {
    display: flex;
    justify-content: space-between;
    flex-wrap: wrap;
    margin-bottom: 20px;
  }
  
  .stat-card {
    background-color: #f9f9f9;
    border-radius: 8px;
    padding: 15px;
    margin: 10px 0;
    flex: 1;
    min-width: 200px;
    margin-right: 15px;
    border-left: 4px solid #2E8B57;
  }
  
  .stat-value {
    font-size: 24px;
    font-weight: bold;
    color: #2E8B57;
  }
  
  .stat-label {
    color: #666;
    font-size: 14px;
  }
  
  .tyre-badge {
    display: inline-block;
    padding: 3px 8px;
    border-radius: 12px;
    font-size: 12px;
    font-weight: 500;
    margin-left: 5px;
  }
  
  .badge-new {
    background-color: #28a745;
    color: white;
  }
  
  .badge-used {
    background-color: #ffc107;
    color: #212529;
  }
  
  .badge-old {
    background-color: #dc3545;
    color: white;
  }
</style>

<!-- Add this HTML right before the closing </div> of the container div -->
<div id="tyreHistoryModal" class="modal">
  <div class="modal-content">
    <span class="close-modal" onclick="closeHistoryModal()">&times;</span>
    <h2 id="historyTitle">Tyre History</h2>
    
    <div class="tyre-stats" id="tyreStats">
      <!-- Stats will be populated dynamically -->
    </div>
    
    <table class="history-table" id="historyTable">
      <thead>
        <tr>
          <th>Date</th>
          <th>Tyre Number</th>
          <th>Brand</th>
          <th>Size</th>
          <th>Position</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody id="historyTableBody">
        <!-- History entries will be populated dynamically -->
      </tbody>
    </table>
  </div>
</div>

<!-- Update the renderCard function in the JavaScript section -->
<script>
  // Add these functions to your existing script
  
  // Modify the loadVehicles function to add the history button
  window.loadVehicles = function() {
    const vehicleListContainer = document.getElementById('vehicleList');
    vehicleListContainer.innerHTML = '<p>Loading vehicles...</p>';
    
    const vehiclesRef = ref(db, `users/${currentUser.uid}/vehicles`);
    
    onValue(vehiclesRef, (snapshot) => {
      if (!snapshot.exists()) {
        vehicleListContainer.innerHTML = '<p>No vehicles found</p>';
        return;
      }
      
      const vehicles = snapshot.val();
      let vehicleHtml = '';
      
      for (const vehicleId in vehicles) {
        const vehicle = vehicles[vehicleId];
        const tyres = vehicle.tyres || [];
        
        let tyresHtml = '';
        for (const tyre of tyres) {
          // Add age badge to each tyre
          const tyreAge = getTyreAge(tyre.addedAt);
          let badgeClass = 'badge-new';
          let badgeText = 'New';
          
          if (tyreAge > 180) { // older than 6 months
            badgeClass = 'badge-old';
            badgeText = 'Old';
          } else if (tyreAge > 30) { // older than 1 month
            badgeClass = 'badge-used';
            badgeText = 'Used';
          }
          
          tyresHtml += `
            <div class="tyre-card">
              <div class="tyre-actions">
                <button class="action-btn edit-btn" onclick="editTyre('${vehicleId}', '${tyre.number}')">Edit</button>
                <button class="action-btn delete-btn" onclick="disposeTyre('${vehicleId}', '${tyre.number}')">Dispose</button>
              </div>
              <p><strong>Number:</strong> ${tyre.number} <span class="tyre-badge ${badgeClass}">${badgeText}</span></p>
              <p><strong>Brand:</strong> ${tyre.brand}</p>
              <p><strong>Size:</strong> ${tyre.size}</p>
              <p><strong>Position:</strong> ${tyre.position}</p>
            </div>
          `;
        }
        
        vehicleHtml += `
          <div class="vehicle-card">
            <div class="vehicle-header">
              <div>${vehicle.vehicleNumber} - ${vehicle.vehicleModel}</div>
              <div class="vehicle-actions">
                <button class="btn btn-primary" onclick="addTyreToVehicle('${vehicleId}')">Add Tyre</button>
                <button class="btn history-btn" onclick="showTyreHistory('${vehicleId}')">Tyre History</button>
                <button class="btn btn-warning" onclick="editVehicle('${vehicleId}')">Edit Vehicle</button>
                <button class="btn btn-danger" onclick="deleteVehicle('${vehicleId}')">Delete Vehicle</button>
              </div>
            </div>
            <div class="tyre-grid">
              ${tyresHtml}
            </div>
          </div>
        `;
      }
      
      vehicleListContainer.innerHTML = vehicleHtml;
    });
  };
  
  // Function to calculate tyre age in days
  function getTyreAge(timestamp) {
    if (!timestamp) return 0;
    const now = Date.now();
    const ageInMs = now - timestamp;
    return Math.floor(ageInMs / (1000 * 60 * 60 * 24)); // Convert ms to days
  }
  
  // Function to show tyre history modal
  window.showTyreHistory = function(vehicleId) {
    window.get(window.ref(window.db, `users/${window.currentUser.uid}/vehicles/${vehicleId}`)).then((snapshot) => {
      if (snapshot.exists()) {
        const vehicle = snapshot.val();
        const tyres = vehicle.tyres || [];
        
        // Set modal title
        document.getElementById('historyTitle').textContent = `Tyre History - ${vehicle.vehicleNumber}`;
        
        // Populate tyre stats
        const statsContainer = document.getElementById('tyreStats');
        const totalTyres = tyres.length;
        const newTyres = tyres.filter(t => getTyreAge(t.addedAt) <= 30).length;
        const usedTyres = tyres.filter(t => getTyreAge(t.addedAt) > 30 && getTyreAge(t.addedAt) <= 180).length;
        const oldTyres = tyres.filter(t => getTyreAge(t.addedAt) > 180).length;
        
        statsContainer.innerHTML = `
          <div class="stat-card">
            <div class="stat-value">${totalTyres}</div>
            <div class="stat-label">Total Tyres</div>
          </div>
          <div class="stat-card">
            <div class="stat-value">${newTyres}</div>
            <div class="stat-label">New Tyres (<30 days)</div>
          </div>
          <div class="stat-card">
            <div class="stat-value">${usedTyres}</div>
            <div class="stat-label">Used Tyres (1-6 months)</div>
          </div>
          <div class="stat-card">
            <div class="stat-value">${oldTyres}</div>
            <div class="stat-label">Old Tyres (>6 months)</div>
          </div>
        `;
        
        // Populate history table
        const historyTableBody = document.getElementById('historyTableBody');
        historyTableBody.innerHTML = '';
        
        // Sort tyres by added date (newest first)
        const sortedTyres = [...tyres].sort((a, b) => (b.addedAt || 0) - (a.addedAt || 0));
        
        for (const tyre of sortedTyres) {
          const row = document.createElement('tr');
          const date = tyre.addedAt ? new Date(tyre.addedAt).toLocaleDateString() : 'Unknown';
          
          row.innerHTML = `
            <td>${date}</td>
            <td>${tyre.number}</td>
            <td>${tyre.brand}</td>
            <td>${tyre.size}</td>
            <td>${tyre.position}</td>
            <td>
              <button class="action-btn edit-btn" onclick="editTyre('${vehicleId}', '${tyre.number}'); closeHistoryModal();">Edit</button>
            </td>
          `;
          
          historyTableBody.appendChild(row);
        }
        
        // Show the modal
        document.getElementById('tyreHistoryModal').style.display = 'block';
      }
    });
  };
  
  // Function to close the history modal
  window.closeHistoryModal = function() {
    document.getElementById('tyreHistoryModal').style.display = 'none';
  };
  
  // Close modal when clicking outside of it
  window.onclick = function(event) {
    const modal = document.getElementById('tyreHistoryModal');
    if (event.target === modal) {
      closeHistoryModal();
    }
  };
  
  // Modify the saveVehicle function to track tyre history
  window.saveVehicle = async function() {
    // ... existing code ...
    
    // Add timestamp to each tyre if not already present
    for (const tyre of tyres) {
      if (!tyre.addedAt) {
        tyre.addedAt = Date.now();
      }
    }
    
    // ... rest of the existing function ...
  };
</script>